<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Password - Messaging Platform</title>
    <link rel="stylesheet" href="../css/toast.css">
    <link rel="stylesheet" href="css/developer.css">
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>üîê Password Change Required</h1>
                <p>For security reasons, please set a new password</p>
            </div>

            <form id="changePasswordForm" class="login-form">
                <div class="form-group">
                    <label for="currentPassword">Current Password</label>
                    <input type="password" id="currentPassword" name="currentPassword" required
                           placeholder="Your temporary password">
                </div>

                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" name="newPassword" required
                           placeholder="At least 8 characters" minlength="8">
                    <span class="hint">Minimum 8 characters</span>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required
                           placeholder="Repeat your new password">
                </div>

                <button type="submit" class="btn btn-primary" id="changeBtn">
                    Change Password
                </button>

                <div id="changeError" class="error-message" style="display: none;"></div>
            </form>

            <div class="login-footer">
                <a href="#" class="link" onclick="logout()">Logout</a>
            </div>
        </div>
    </div>

    <script src="../js/api-config.js"></script>
    <script src="js/developer-api.js"></script>
    <script>
        // Redirect if not logged in
        if (!DeveloperAPI.isLoggedIn()) {
            window.location.href = 'index.html';
        }

        function logout() {
            DeveloperAPI.logout();
            window.location.href = 'index.html';
        }

        // Handle password change form
        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('changeError');
            const changeBtn = document.getElementById('changeBtn');

            errorDiv.style.display = 'none';

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'New passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            changeBtn.disabled = true;
            changeBtn.textContent = 'Changing...';

            try {
                await DeveloperAPI.changePassword(currentPassword, newPassword);

                // Update profile to remove password change flag
                const profile = DeveloperAPI.getProfile();
                if (profile) {
                    profile.passwordChangeRequired = false;
                    DeveloperAPI.setProfile(profile);
                }

                // Redirect to dashboard
                window.location.href = 'dashboard.html';
            } catch (error) {
                errorDiv.textContent = error.message || 'Failed to change password. Please try again.';
                errorDiv.style.display = 'block';
                changeBtn.disabled = false;
                changeBtn.textContent = 'Change Password';
            }
        });
    </script>
</body>
</html>

